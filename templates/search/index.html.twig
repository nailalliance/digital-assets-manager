{% extends 'base.html.twig' %}

{% block title %}
    {% if query is defined and query is not empty %}
        Search Results for "{{ query }}"
    {% else %}
        Browse Assets
    {% endif %}
    | {{ parent() }}
{% endblock %}

{% block body %}
    <div class="flex flex-col md:flex-row gap-8" data-controller="quick-look">

        {# Filter Sidebar #}
        {{ include('search/_side_bar.html.twig') }}

        {# Main Content - Asset Grid #}
        <main class="w-full md:w-3/4 lg:w-4/5">
            {# Search Bar #}
             <div class="mb-6">
                 <form data-turbo="false" action="{{ path('app_search') }}" method="get">
                     {% for collectionId in selectedCollectionIds %}
                         <input type="hidden" name="collection_ids[]" value="{{ collectionId }}">
                     {% endfor %}
                     {% for categoryId in selectedCategoryIds %}
                         <input type="hidden" name="category_ids[]" value="{{ categoryId }}">
                     {% endfor %}

                     {% for brandId in selectedBrandIds %}
                         <input type="hidden" name="brand_ids[]" value="{{ brandId }}">
                     {% endfor %}

                     <div class="relative">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                             <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                         </div>
                         <input type="search" name="q" value="{{ query }}" class="w-full p-4 pl-10 text-lg border-2 border-gray-300 rounded-full focus:ring-violet-500 focus:border-violet-500" placeholder="e.g., Summer Logo, P-12345, social media...">
                     </div>
                 </form>
             </div>

            {# File Type Filters #}
            {{ include('search/_file_filters.html.twig') }}

            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">
                    {% if query is not empty %}
                        Results for "<span class="text-violet-600">{{ query }}</span>"
                    {% elseif selectedCollectionIds is not empty and activeCollections|filter(c => c.id in selectedCollectionIds)|length > 0 %}
                        {{ activeCollections|filter(c => c.id in selectedCollectionIds)|first.name }}
                    {% elseif selectedCategoryIds is not empty and activeCategories|filter(c => c.id in selectedCategoryIds)|length > 0 %}
                        {{ activeCategories|filter(c => c.id in selectedCategoryIds)|first.name }}
                    {% else %}
                        Browse Assets
                    {% endif %}
                </h1>
                <div class="flex items-center space-x-4">
                    {% if assets is not empty %}
                        <form method="post" action="{{ path('download_list_add_multiple') }}"
                              data-controller="add-all-to-bag" data-action="submit->add-all-to-bag#addAll">
                            <input type="hidden" name="asset_ids" data-add-all-to-bag-target="idsInput">
                            <button type="submit" class="text-sm font-medium text-violet-600 hover:text-violet-800">Add
                                All to Bag
                            </button>
                        </form>
                    {% endif %}
                    <form method="get" action="{{ path('app_search') }}" class="flex items-center space-x-2 text-sm">
                        {% for key, value in app.request.query.all %}
                            {% if key != 'limit' and key != 'page' %}
                                {% if value is iterable %}
                                    {% for item in value %}
                                        <input type="hidden" name="{{ key }}[]" value="{{ item }}">
                                    {% endfor %}
                                {% else %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <label for="limit-selector">Show:</label>
                        <select name="limit" id="limit-selector" onchange="this.form.submit()"
                                class="border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500 text-sm">
                            <option value="20" {{ paginator.limit == 20 ? 'selected' : '' }}>20</option>
                            <option value="50" {{ paginator.limit == 50 ? 'selected' : '' }}>50</option>
                            <option value="100" {{ paginator.limit == 100 ? 'selected' : '' }}>100</option>
                        </select>
                        <span class="text-gray-600">of {{ paginator.totalItems }} items</span>
                    </form>
                </div>
            </div>

            {{ include('search/_assets_grid.html.twig') }}

            {# Pagination Controls #}
            {% if paginator.totalPages > 1 %}
                <nav class="mt-8 flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
                    <div class="-mt-px flex w-0 flex-1">
                        {% if paginator.currentPage > 1 %}
                            <a data-turbo="false" href="{{ path('app_search', app.request.query.all|merge({'page': paginator.currentPage - 1})) }}" class="inline-flex items-center border-t-2 border-transparent pr-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                                <svg class="mr-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a.75.75 0 01-.75.75H4.66l2.1 1.95a.75.75 0 11-1.02 1.1l-3.5-3.25a.75.75 0 010-1.1l3.5-3.25a.75.75 0 111.02 1.1l-2.1 1.95h12.59A.75.75 0 0118 10z" clip-rule="evenodd" /></svg>
                                Previous
                            </a>
                        {% endif %}
                    </div>
                    <div class="hidden md:-mt-px md:flex">
                        {% set maxPagesToShow = 5 %}
                        {% set startPage = max(1, paginator.currentPage - (maxPagesToShow // 2)) %}
                        {% set endPage = min(paginator.totalPages, startPage + maxPagesToShow - 1) %}

                        {% if startPage > 1 %}
                            <a data-turbo="false" href="{{ path('app_search', app.request.query.all|merge({'page': 1})) }}" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">1</a>
                            {% if startPage > 2 %}
                                <span class="border-transparent text-gray-500 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">...</span>
                            {% endif %}
                        {% endif %}

                        {% for i in startPage..endPage %}
                            <a data-turbo="false" href="{{ path('app_search', app.request.query.all|merge({'page': i})) }}" class="{{ i == paginator.currentPage ? 'border-violet-500 text-violet-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">{{ i }}</a>
                        {% endfor %}

                        {% if endPage < paginator.totalPages %}
                            {% if endPage < paginator.totalPages - 1 %}
                                <span class="border-transparent text-gray-500 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">...</span>
                            {% endif %}
                            <a data-turbo="false" href="{{ path('app_search', app.request.query.all|merge({'page': paginator.totalPages})) }}" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">{{ paginator.totalPages }}</a>
                        {% endif %}
                    </div>
                    <div class="-mt-px flex w-0 flex-1 justify-end">
                        {% if paginator.currentPage < paginator.totalPages %}
                            <a data-turbo="false" href="{{ path('app_search', app.request.query.all|merge({'page': paginator.currentPage + 1})) }}" class="inline-flex items-center border-t-2 border-transparent pl-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                                Next
                                <svg class="ml-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M2 10a.75.75 0 01.75-.75h12.59l-2.1-1.95a.75.75 0 111.02-1.1l3.5 3.25a.75.75 0 010 1.1l-3.5 3.25a.75.75 0 11-1.02-1.1l2.1-1.95H2.75A.75.75 0 012 10z" clip-rule="evenodd" /></svg>
                            </a>
                        {% endif %}
                    </div>
                </nav>
            {% endif %}
        </main>

        {# Quick look modal conatainer #}
        <dialog id="quick-look-dialog" data-quick-look-target="dialog" class="p-0 rounded-lg shadow-xl m-auto">
            <div data-quick-look-target="content"></div>
        </dialog>
    </div>
{% endblock %}
