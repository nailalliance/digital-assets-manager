{% extends 'base.html.twig' %}

{% block title %}
    {% if query is defined and query is not empty %}
        Search Results for "{{ query }}"
    {% else %}
        Browse Assets
    {% endif %}
    | {{ parent() }}
{% endblock %}

{% block body %}
    <div class="flex flex-col md:flex-row gap-8" data-controller="quick-look">

        {# Filter Sidebar #}
        <aside class="w-full md:w-1/4 lg:w-1/5">
            <h2 class="text-xl font-bold mb-4">Refine Results</h2>

            <form name="filters" method="get" action="{{ path('app_search') }}" data-controller="filter-form" data-action="change->filter-form#submit">
                <input type="hidden" name="q" value="{{ query }}">

                {# Collections Filter #}
                {% if activeCollections is not empty %}
                    <div class="mb-2" data-controller="accordion">
                        <h3 class="font-semibold mb-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center" data-action="click->accordion#toggle">
                            <span>Collections</span>
                            <svg class="h-5 w-5 transform transition-transform" data-accordion-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </h3>
                        <div class="space-y-2 pl-2 hidden" data-accordion-target="content">
                            {% set year = -1 %}
                            {% for collection in activeCollections|sort((a, b) => b.year <=> a.year) %}
                                {% if year != collection.year %}
                                    <h4 class="font-bold pt-2">{{ collection.year }}</h4>
                                    {% set year = collection.year %}
                                {% endif %}
                                <label class="flex items-center">
                                    <input type="checkbox" name="collection_ids[]" value="{{ collection.id }}" class="h-4 w-4 rounded border-gray-300 text-violet-600 focus:ring-violet-500 mr-2" {{ collection.id in selectedCollectionIds ? 'checked' : '' }}>
                                    {{ collection.name }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {# Categories Filter #}
                {% if activeCategories is not empty %}
                    <div class="mb-2 pt-2 border-t border-gray-200" data-controller="accordion">
                        <h3 class="font-semibold mb-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center" data-action="click->accordion#toggle">
                            <span>Categories</span>
                            <svg class="h-5 w-5 transform transition-transform" data-accordion-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </h3>
                        <div class="space-y-2 pl-2 hidden" data-accordion-target="content">
                            {% for category in activeCategories|sort((a, b) => a.name <=> b.name) %}
                                <label class="flex items-center">
                                    <input type="checkbox" name="category_ids[]" value="{{ category.id }}" class="h-4 w-4 rounded border-gray-300 text-violet-600 focus:ring-violet-500 mr-2" {{ category.id in selectedCategoryIds ? 'checked' : '' }}>
                                    {{ category.name }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {# Brands Filter #}
                {% if brandFilters.parents is not empty %}
                    <div class="mb-2 pt-2 border-t border-gray-200" data-controller="accordion">
                        <h3 class="font-semibold mb-2 p-2 rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center" data-action="click->accordion#toggle">
                            <span>Brands</span>
                            <svg class="h-5 w-5 transform transition-transform" data-accordion-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </h3>
                        <div class="space-y-2 pl-2 hidden" data-accordion-target="content">
                            {% for parent in brandFilters.parents|sort((a, b) => a.name <=> b.name) %}
                                <div data-controller="accordion">
                                    <label class="flex items-center font-medium p-2 rounded-md hover:bg-gray-100 cursor-pointer" data-action="click->accordion#toggle">
                                        <input type="checkbox" name="brand_ids[]" value="{{ parent.id }}" class="h-4 w-4 rounded border-gray-300 text-violet-600 focus:ring-violet-500 mr-2" {{ parent.id in selectedBrandIds ? 'checked' : '' }}>
                                        {{ parent.name }}
                                    </label>
                                    {% if brandFilters.children[parent.id] is defined %}
                                        <div class="sub-brands pl-6 mt-2 space-y-2" data-accordion-target="content">
                                            {% for child in brandFilters.children[parent.id]|sort((a, b) => a.name <=> b.name) %}
                                                <label class="flex items-center">
                                                    <input type="checkbox" name="brand_ids[]" value="{{ child.id }}" class="h-4 w-4 rounded border-gray-300 text-violet-600 focus:ring-violet-500 mr-2" {{ child.id in selectedBrandIds ? 'checked' : '' }}>
                                                    {{ child.name }}
                                                </label>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {# <div class="pt-6 border-t border-gray-200"> #}
                {#     <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-violet-600 hover:bg-violet-700"> #}
                {#         Apply Filters #}
                {#     </button> #}
                {# </div> #}
            </form>
        </aside>

        {# Main Content - Asset Grid #}
        <main class="w-full md:w-3/4 lg:w-4/5">
            {# Search Bar #}
             <div class="mb-6">
                 <form action="{{ path('app_search') }}" method="get">
                     {% for collectionId in selectedCollectionIds %}
                         <input type="hidden" name="collection_ids[]" value="{{ collectionId }}">
                     {% endfor %}
                     {% for categoryId in selectedCategoryIds %}
                         <input type="hidden" name="category_ids[]" value="{{ categoryId }}">
                     {% endfor %}

                     {% for brandId in selectedBrandIds %}
                         <input type="hidden" name="brand_ids[]" value="{{ brandId }}">
                     {% endfor %}

                     <div class="relative">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                             <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                         </div>
                         <input type="search" name="q" value="{{ query }}" class="w-full p-4 pl-10 text-lg border-2 border-gray-300 rounded-full focus:ring-violet-500 focus:border-violet-500" placeholder="e.g., Summer Logo, P-12345, social media...">
                     </div>
                 </form>
             </div>

            {# File Type Filters #}
            <div class="mb-6">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    {% set file_types = [
                        { group: 'images', label: 'Images' },
                        { group: 'documents', label: 'Documents' },
                        { group: 'videos', label: 'Videos' },
                        { group: 'audio', label: 'Audio' },
                        { group: 'zip', label: 'Zip' },
                    ] %}

                    {% for type in file_types %}
                        {% if selectedFileTypeGroup == type.group %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'file_type_group': null})) }}" data-turbo="false"
                               class="flex flex-col items-center justify-center text-center p-4 rounded-lg border-2 transition-colors bg-violet-600 text-white border-violet-600">
                                <span class="font-semibold text-sm">{{ type.label }}</span>
                            </a>
                        {% else %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'file_type_group': type.group})) }}" data-turbo="false"
                               class="flex flex-col items-center justify-center text-center p-4 rounded-lg border-2 transition-colors bg-white text-gray-700 border-gray-200 hover:border-violet-400">
                                <span class="font-semibold text-sm">{{ type.label }}</span>
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if selectedFileTypeGroup %}
                    <div class="text-center mt-2">
                        <a href="{{ path('app_search', app.request.query.all|merge({'file_type_group': null})) }}" data-turbo="false"  class="text-xs text-gray-500 hover:text-violet-600">Clear File Type Filter</a>
                    </div>
                {% endif %}
            </div>

            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">
                    {% if query is not empty %}
                        Results for "<span class="text-violet-600">{{ query }}</span>"
                    {% elseif selectedCollectionIds is not empty and activeCollections|filter(c => c.id in selectedCollectionIds)|length > 0 %}
                        {{ activeCollections|filter(c => c.id in selectedCollectionIds)|first.name }}
                    {% elseif selectedCategoryIds is not empty and activeCategories|filter(c => c.id in selectedCategoryIds)|length > 0 %}
                        {{ activeCategories|filter(c => c.id in selectedCategoryIds)|first.name }}
                    {% else %}
                        Browse Assets
                    {% endif %}
                </h1>
                <div class="flex items-center space-x-4">
                    {% if assets is not empty %}
                        <form method="post" action="{{ path('download_list_add_multiple') }}"
                              data-controller="add-all-to-bag" data-action="submit->add-all-to-bag#addAll">
                            <input type="hidden" name="asset_ids" data-add-all-to-bag-target="idsInput">
                            <button type="submit" class="text-sm font-medium text-violet-600 hover:text-violet-800">Add
                                All to Bag
                            </button>
                        </form>
                    {% endif %}
                    <form method="get" action="{{ path('app_search') }}" class="flex items-center space-x-2 text-sm">
                        {% for key, value in app.request.query.all %}
                            {% if key != 'limit' and key != 'page' %}
                                {% if value is iterable %}
                                    {% for item in value %}
                                        <input type="hidden" name="{{ key }}[]" value="{{ item }}">
                                    {% endfor %}
                                {% else %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <label for="limit-selector">Show:</label>
                        <select name="limit" id="limit-selector" onchange="this.form.submit()"
                                class="border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500 text-sm">
                            <option value="20" {{ paginator.limit == 20 ? 'selected' : '' }}>20</option>
                            <option value="50" {{ paginator.limit == 50 ? 'selected' : '' }}>50</option>
                            <option value="100" {{ paginator.limit == 100 ? 'selected' : '' }}>100</option>
                        </select>
                        <span class="text-gray-600">of {{ paginator.totalItems }} items</span>
                    </form>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% if assets is not empty %}
                    {% for asset in assets %}
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden flex flex-col" data-asset-id="{{ asset.id }}">
                            <a href="{{ path('app_asset', {id: asset.id}) }}" class="block relative">
                                <div class="aspect-square w-full bg-gray-200 flex items-center justify-center">
                                    {% if asset.thumbnailPath is not null and asset.thumbnailPath is not empty %}
                                        <img src="{{ path('asset_thumbnail', {filename: asset.thumbnailPath|basename}) }}" alt="{{ asset.name }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"></path></svg>
                                    {% endif %}
                                </div>
                                {% if asset.colorSpace.value == 'cmyk' %}
                                    <span class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow">PRINT ONLY</span>
                                {% elseif asset.colorSpace.value == 'rgb' %}
                                    <span class="absolute top-2 right-2 bg-gray-200 text-gray-700 text-xs font-bold px-2 py-1 rounded-full shadow">WEB</span>
                                {% endif %}
                                <div class="p-3">
                                    <p class="font-semibold text-sm truncate" title="{{ asset.name }}">{{ asset.name }}</p>
                                    <p class="text-xs text-gray-500">{{ asset.itemCodes|map(item => item.code)|join(', ') }}</p>
                                    <p class="text-xs text-gray-500">{{ asset.mimeType }}</p>
                                    <div class="mt-2 flex flex-wrap gap-2">
                                        {% for brand in asset.brand %}
                                            <span class="bg-violet-100 text-violet-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ brand.name }}</span>
                                        {% endfor %}
                                        {% for category in asset.categories %}
                                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ category.name }}</span>
                                        {% endfor %}
                                        {% for collection in asset.collections %}
                                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ collection.name }} ({{ collection.year }})</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </a>
                            <div class="mt-auto p-3 border-t border-gray-200 bg-gray-50 flex items-center justify-center space-x-2">
                                <a href="{{ path('app_asset_quick_look', {id: asset.id}) }}" data-action="click->quick-look#open" title="Quick Look" class="p2-text-gray-500 hover:text-violet-600 transition-colors">
                                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                </a>
                                <a href="{{ path('asset_download', {id: asset.id}) }}" data-turbo="false" title="Download" class="p-2 text-gray-500 hover:text-violet-600 transition-colors">
                                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                </a>
                                <form action="{{ path('download_list_add', {id: asset.id}) }}" method="post">
                                    <button type="submit" title="Add to Download Bag" class="p-2 text-gray-500 hover:text-violet-600 transition-colors">
                                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-full text-center py-12 bg-white rounded-lg shadow-sm">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No assets found</h3>
                        <p class="mt-1 text-sm text-gray-500">
                            Try adjusting your search or filter terms.
                        </p>
                    </div>
                {% endif %}
            </div>

            {# Pagination Controls #}
            {% if paginator.totalPages > 1 %}
                <nav class="mt-8 flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
                    <div class="-mt-px flex w-0 flex-1">
                        {% if paginator.currentPage > 1 %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'page': paginator.currentPage - 1})) }}" class="inline-flex items-center border-t-2 border-transparent pr-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                                <svg class="mr-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a.75.75 0 01-.75.75H4.66l2.1 1.95a.75.75 0 11-1.02 1.1l-3.5-3.25a.75.75 0 010-1.1l3.5-3.25a.75.75 0 111.02 1.1l-2.1 1.95h12.59A.75.75 0 0118 10z" clip-rule="evenodd" /></svg>
                                Previous
                            </a>
                        {% endif %}
                    </div>
                    <div class="hidden md:-mt-px md:flex">
                        {% set maxPagesToShow = 5 %}
                        {% set startPage = max(1, paginator.currentPage - (maxPagesToShow // 2)) %}
                        {% set endPage = min(paginator.totalPages, startPage + maxPagesToShow - 1) %}

                        {% if startPage > 1 %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'page': 1})) }}" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">1</a>
                            {% if startPage > 2 %}
                                <span class="border-transparent text-gray-500 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">...</span>
                            {% endif %}
                        {% endif %}

                        {% for i in startPage..endPage %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'page': i})) }}" class="{{ i == paginator.currentPage ? 'border-violet-500 text-violet-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">{{ i }}</a>
                        {% endfor %}

                        {% if endPage < paginator.totalPages %}
                            {% if endPage < paginator.totalPages - 1 %}
                                <span class="border-transparent text-gray-500 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">...</span>
                            {% endif %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'page': paginator.totalPages})) }}" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center border-t-2 px-4 pt-4 text-sm font-medium">{{ paginator.totalPages }}</a>
                        {% endif %}
                    </div>
                    <div class="-mt-px flex w-0 flex-1 justify-end">
                        {% if paginator.currentPage < paginator.totalPages %}
                            <a href="{{ path('app_search', app.request.query.all|merge({'page': paginator.currentPage + 1})) }}" class="inline-flex items-center border-t-2 border-transparent pl-1 pt-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                                Next
                                <svg class="ml-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M2 10a.75.75 0 01.75-.75h12.59l-2.1-1.95a.75.75 0 111.02-1.1l3.5 3.25a.75.75 0 010 1.1l-3.5 3.25a.75.75 0 11-1.02-1.1l2.1-1.95H2.75A.75.75 0 012 10z" clip-rule="evenodd" /></svg>
                            </a>
                        {% endif %}
                    </div>
                </nav>
            {% endif %}
        </main>

        {# Quick look modal conatainer #}
        <dialog id="quick-look-dialog" data-quick-look-target="dialog" class="p-0 rounded-lg shadow-xl m-auto">
            <div data-quick-look-target="content"></div>
        </dialog>
    </div>
{% endblock %}
